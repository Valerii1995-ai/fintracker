<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–∫–µ—Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            /* –£–º–µ–Ω—å—à–∞–µ–º –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem; /* –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–µ–Ω */
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
            }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8">
            <!-- –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Ä–∞–∑–º–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
            <h1 class="text-2xl sm:text-3xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-400">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–∫–µ—Ä</h1>
            <p class="text-center text-gray-400 mt-2 text-sm">–í–∞—à –ª–∏—á–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–æ–≤.</p>
        </header>

        <!-- –°–≤–æ–¥–∫–∞ (Dashboard) -->
        <div id="dashboard" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ —á–µ—Ä–µ–∑ JS -->
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ -->
        <div id="loading-message" class="text-center text-gray-400 py-8">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç...</p>
        </div>

        <!-- –°—á–µ—Ç–∞ -->
        <main id="accounts-section" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ –∫–Ω–æ–ø–∫–∏-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è -->
                <h2 class="text-xl font-bold">–ú–æ–∏ —Å—á–µ—Ç–∞</h2>
                <button id="add-account-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 text-sm">
                    + –î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç
                </button>
            </div>
            <!-- –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—á–µ—Ç–æ–≤, –±–µ–∑ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è -->
            <div id="accounts-content-wrapper">
                <div id="accounts-list" class="space-y-4 pb-1">
                    <!-- –°–ø–∏—Å–æ–∫ —Å—á–µ—Ç–æ–≤ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω —Å—é–¥–∞ —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>
        </main>

        <!-- –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞ -->
        <section id="log-section" class="hidden mt-8">
            <div class="flex justify-between items-center mb-4">
                <!-- –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Ä–∞–∑–º–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
                <h2 class="text-xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–∞</h2>
                <button id="log-balance-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 text-sm">
                    –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫
                </button>
            </div>
            <div id="logs-list" class="space-y-2">
                <!-- –ó–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ —á–µ—Ä–µ–∑ JS -->
            </div>
        </section>

        <!-- –ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏ -->
        <section id="data-management-section" class="mt-8">
            <h2 class="text-xl font-bold mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h2>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <button id="export-data-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 text-sm">
                    –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                </button>
                <input type="file" id="import-file-input" accept=".json" class="hidden">
                <button id="import-data-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 text-sm">
                    –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                </button>
            </div>
        </section>

    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—á–µ—Ç–∞ -->
    <div id="account-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 modal-content transform scale-95">
            <h3 id="modal-title" class="text-xl font-bold mb-6">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—á–µ—Ç</h3>
            <form id="account-form">
                <input type="hidden" id="account-id">
                
                <div class="mb-4">
                    <label for="account-name" class="block text-gray-300 text-sm font-bold mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞</label>
                    <input type="text" id="account-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm" required>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="account-amount" class="block text-gray-300 text-sm font-bold mb-2">–°—É–º–º–∞</label>
                        <input type="number" step="any" id="account-amount" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm" required>
                    </div>
                    <div>
                        <label for="account-currency" class="block text-gray-300 text-sm font-bold mb-2">–í–∞–ª—é—Ç–∞</label>
                        <input type="text" id="account-currency" placeholder="RUB, USD, TON..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white uppercase focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm" required>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="account-type" class="block text-gray-300 text-sm font-bold mb-2">–¢–∏–ø –∞–∫—Ç–∏–≤–∞</label>
                    <select id="account-type" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                        <option>–†—É–±–ª–∏</option>
                        <option>–í–∞–ª—é—Ç–∞</option>
                        <option>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</option>
                        <option>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</option>
                    </select>
                </div>
                
                <div id="manual-rate-container" class="mb-6 hidden">
                    <label for="manual-rate" class="block text-gray-300 text-sm font-bold mb-2">–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å –∫ USD (–≤—Ä—É—á–Ω—É—é)</label>
                    <input type="number" step="any" id="manual-rate" placeholder="–ù–∞–ø—Ä. 7.5 –¥–ª—è TON" class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                    <p class="text-xs text-gray-500 mt-1">–î–ª—è –∞–∫—Ç–∏–≤–æ–≤, —á–µ–π –∫—É—Ä—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm p-6 modal-content transform scale-95 text-center">
            <h3 class="text-lg font-bold mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            <p class="text-gray-300 mb-6 text-sm">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å—á–µ—Ç?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors text-sm">–ù–µ—Ç</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors text-sm">–î–∞</button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM ELEMENTS ---
    const app = {
        dashboard: document.getElementById('dashboard'),
        loadingMessage: document.getElementById('loading-message'),
        accountsSection: document.getElementById('accounts-section'),
        accountsList: document.getElementById('accounts-list'),
        addAccountBtn: document.getElementById('add-account-btn'),
        logSection: document.getElementById('log-section'),
        logBalanceBtn: document.getElementById('log-balance-btn'),
        logsList: document.getElementById('logs-list'),
        modal: {
            el: document.getElementById('account-modal'),
            title: document.getElementById('modal-title'),
            form: document.getElementById('account-form'),
            id: document.getElementById('account-id'),
            name: document.getElementById('account-name'),
            amount: document.getElementById('account-amount'),
            currency: document.getElementById('account-currency'),
            type: document.getElementById('account-type'),
            manualRateContainer: document.getElementById('manual-rate-container'),
            manualRate: document.getElementById('manual-rate'),
            cancelBtn: document.getElementById('cancel-btn'),
        },
        deleteModal: {
            el: document.getElementById('delete-confirm-modal'),
            cancelBtn: document.getElementById('cancel-delete-btn'),
            confirmBtn: document.getElementById('confirm-delete-btn')
        },
        // –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏
        exportDataBtn: document.getElementById('export-data-btn'),
        importDataBtn: document.getElementById('import-data-btn'),
        importFileInput: document.getElementById('import-file-input')
    };

    // --- APPLICATION STATE ---
    let state = {
        accounts: [],
        logs: [],
        rates: {},
        accountToDeleteId: null
    };

    // --- INITIAL DATA (for first run only) ---
    const initialAccounts = [
        { id: '1', name: '–ö–∞—Ä—Ç–∞ –¢–∏–Ω—å–∫–æ—Ñ—Ñ (–º–æ—è)', amount: 150000, currency: 'RUB', type: '–†—É–±–ª–∏' },
        { id: '2', name: '–ö–∞—Ä—Ç–∞ –¢–∏–Ω—å–∫–æ—Ñ—Ñ (–∂–µ–Ω—ã)', amount: 100000, currency: 'RUB', type: '–†—É–±–ª–∏' },
        { id: '3', name: '–ù–∞–ª–∏—á–Ω—ã–µ —Ä—É–±–ª–∏', amount: 50000, currency: 'RUB', type: '–†—É–±–ª–∏' },
        { id: '4', name: '–ö–∞—Ä—Ç–∞ –¢–∏–Ω—å–∫–æ—Ñ—Ñ (–∂–µ–Ω—ã, $)', amount: 1500, currency: 'USD', type: '–í–∞–ª—é—Ç–∞' },
        { id: '5', name: '–ö–∞—Ä—Ç–∞ –¢–∏–Ω—å–∫–æ—Ñ—Ñ (–∂–µ–Ω—ã, ‚Ç¨)', amount: 500, currency: 'EUR', type: '–í–∞–ª—é—Ç–∞' },
        { id: '6', name: '–ù–∞–ª–∏—á–Ω—ã–µ –¥–æ–ª–ª–∞—Ä—ã', amount: 2000, currency: 'USD', type: '–í–∞–ª—é—Ç–∞' },
        { id: '7', name: '–ù–∞–ª–∏—á–Ω—ã–µ –±–∞—Ç—ã', amount: 10000, currency: 'THB', type: '–í–∞–ª—é—Ç–∞' },
        { id: '8', name: '–î–æ–ª–ª–∞—Ä–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (–º–æ—è)', amount: 800, currency: 'USD', type: '–í–∞–ª—é—Ç–∞' },
        { id: '9', name: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –ò–ª—å—è', amount: 1000000, currency: 'RUB', type: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏' },
        { id: '10', name: '–¢-–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ (–º–æ–∏)', amount: 500000, currency: 'RUB', type: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏' },
        { id: '11', name: '–¢-–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ (–∂–µ–Ω—ã)', amount: 750000, currency: 'RUB', type: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏' },
        { id: '12', name: '–°—á–µ—Ç –Ω–∞ Bybit', amount: 3000, currency: 'USD', type: '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞' },
        { id: '13', name: '–ö–æ—à–µ–ª–µ–∫ TON', amount: 1875, currency: 'USD', type: '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞' } 
    ];

    // --- FUNCTIONS ---

    /**
     * Formats a number as a currency string with the Ruble symbol.
     */
    const formatRub = (number) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(number);
    
    /**
     * Formats a number with its currency symbol/code.
     */
    const formatCurrency = (amount, currency) => new Intl.NumberFormat('ru-RU', { style: 'decimal' }).format(amount) + ` ${currency}`;
    
    /**
     * Formats a timestamp into a localized date and time string.
     */
    const formatDateTime = (timestamp) => {
        const date = new Date(timestamp);
        return date.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    };

    /**
     * Formats a numeric delta with a sign and appropriate color.
     */
    const formatDelta = (delta) => {
        if (delta === 0) return `<span class="text-gray-400"> (0)</span>`;
        const sign = delta > 0 ? '+' : '';
        const colorClass = delta > 0 ? 'text-emerald-400' : 'text-red-400';
        return `<span class="${colorClass}"> (${sign}${formatRub(delta)})</span>`;
    };

    /**
     * Converts an account's amount to Rubles based on current rates.
     */
    const convertToRub = (account) => {
        const currency = account.currency.toLowerCase();
        if (currency === 'rub') {
            return account.amount;
        }
        // If manualRate is set and USD rate is available, use manualRate * USD rate
        // This is for assets like TON where the manualRate is TON to USD, and then USD to RUB is fetched.
        if (account.manualRate && state.rates.usd) {
            return account.amount * account.manualRate * state.rates.usd.value;
        }
        // Otherwise, use direct conversion from fetched rates
        if (state.rates[currency]) {
            return account.amount * state.rates[currency].value;
        }
        return 0; // Return 0 if conversion is not possible
    };
    
    /**
     * Renders the dashboard with aggregated totals.
     */
    const renderDashboard = () => {
        let totals = { total: 0, rubles: 0, forex: 0, investments: 0, crypto: 0 };
        state.accounts.forEach(acc => {
            const rubValue = convertToRub(acc);
            totals.total += rubValue;
            if (acc.type === '–†—É–±–ª–∏') totals.rubles += rubValue;
            if (acc.type === '–í–∞–ª—é—Ç–∞') totals.forex += rubValue;
            if (acc.type === '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏') totals.investments += rubValue;
            if (acc.type === '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞') totals.crypto += rubValue;
        });
        
        const dashboardCards = [
            { label: '–û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª', value: totals.total, icon: 'üí∞' },
            { label: '–õ–∏–∫–≤–∏–¥–Ω—ã–µ —Ä—É–±–ª–∏', value: totals.rubles, icon: '‚úÖ' },
            { label: '–í–∞–ª—é—Ç–Ω—ã–µ –∞–∫—Ç–∏–≤—ã', value: totals.forex, icon: 'üåé' },
            { label: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', value: totals.investments, icon: 'üìà' },
            { label: '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞', value: totals.crypto, icon: '‚Çø' }
        ];

        app.dashboard.innerHTML = dashboardCards.map(card => `
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <p class="text-xs text-gray-400">${card.icon} ${card.label}</p>
                <p class="text-lg sm:text-xl font-bold tracking-tight">${formatRub(card.value)}</p>
            </div>
        `).join('');
    };

    /**
     * Renders the list of all accounts.
     */
    const renderAccounts = () => {
        if (!state.accounts.length) {
            app.accountsList.innerHTML = `<div class="text-center bg-gray-800 p-8 rounded-lg"><p class="text-gray-400 text-sm">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—á–µ—Ç–æ–≤.</p></div>`;
            return;
        }
        app.accountsList.innerHTML = state.accounts.map(acc => `
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex items-center justify-between space-x-4">
                <div class="flex-grow">
                    <p class="font-bold text-base">${acc.name}</p>
                    <p class="text-gray-400 text-xs">${acc.type}</p>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-base">${formatCurrency(acc.amount, acc.currency)}</p>
                    <p class="text-emerald-400 text-sm font-medium">${formatRub(convertToRub(acc))}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="edit-btn p-2 text-gray-400 hover:text-white transition-colors" data-id="${acc.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                    <button class="delete-btn p-2 text-gray-400 hover:text-red-500 transition-colors" data-id="${acc.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                </div>
            </div>`).join('');
    };

    /**
     * Renders the balance history logs.
     */
    const renderLogs = () => {
        if (!state.logs.length) {
            app.logsList.innerHTML = `<div class="text-center bg-gray-800 p-8 rounded-lg"><p class="text-gray-400 text-sm">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞. –ù–∞–∂–º–∏—Ç–µ "–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫", —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å.</p></div>`;
            return;
        }
        // Sort logs by timestamp in descending order (most recent first)
        state.logs.sort((a, b) => b.timestamp - a.timestamp);

        app.logsList.innerHTML = state.logs.map((log, index) => {
            const loggedDateTime = formatDateTime(log.timestamp);
            const previousLog = state.logs[index + 1]; // Get the previous log for delta calculation

            const totalDelta = previousLog ? log.total - previousLog.total : 0;
            const rublesDelta = previousLog ? log.rubles - previousLog.rubles : 0;
            const forexDelta = previousLog ? log.forex - previousLog.forex : 0;
            const investmentsDelta = previousLog ? log.investments - previousLog.investments : 0;
            const cryptoDelta = previousLog ? log.crypto - previousLog.crypto : 0;

            const ratesHtml = Object.keys(log.rates).map(currency => {
                if (!log.rates[currency] || log.rates[currency].value === 0) return '';
                // Display currency rate to RUB.
                return `<li class="text-xs text-gray-500">1 ${currency.toUpperCase()} = ${log.rates[currency].value.toFixed(2)} RUB</li>`;
            }).filter(Boolean).join('');

            return `
                <div class="bg-gray-800 p-3 rounded-xl flex flex-col justify-between items-start space-y-2">
                    <div class="flex justify-between w-full items-center">
                        <p class="font-medium text-xs text-gray-300">${loggedDateTime}</p>
                        <p class="font-bold text-base ${totalDelta > 0 ? 'text-emerald-400' : (totalDelta < 0 ? 'text-red-400' : 'text-gray-400')}">
                            ${formatRub(log.total)}${formatDelta(totalDelta)}
                        </p>
                    </div>
                    <div class="w-full text-xs">
                        <p class="text-gray-400">–†—É–±–ª–∏: <span class="font-semibold">${formatRub(log.rubles)}${formatDelta(rublesDelta)}</span></p>
                        <p class="text-gray-400">–í–∞–ª—é—Ç–∞: <span class="font-semibold">${formatRub(log.forex)}${formatDelta(forexDelta)}</span></p>
                        <p class="text-gray-400">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: <span class="font-semibold">${formatRub(log.investments)}${formatDelta(investmentsDelta)}</span></p>
                        <p class="text-gray-400">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞: <span class="font-semibold">${formatRub(log.crypto)}${formatDelta(cryptoDelta)}</span></p>
                    </div>
                    ${ratesHtml ? `
                        <button class="toggle-rates-btn text-cyan-400 text-xs mt-2 self-end">–ü–æ–∫–∞–∑–∞—Ç—å –∫—É—Ä—Å—ã</button>
                        <ul class="rates-details hidden w-full list-disc list-inside pl-4 mt-2">
                            ${ratesHtml}
                        </ul>
                    ` : ''}
                </div>`;
        }).join('');

        // Add event listeners for toggling rates details
        app.logsList.querySelectorAll('.toggle-rates-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const ratesDetails = e.target.nextElementSibling;
                ratesDetails.classList.toggle('hidden');
                if (ratesDetails.classList.contains('hidden')) {
                    e.target.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –∫—É—Ä—Å—ã';
                } else {
                    e.target.textContent = '–°–∫—Ä—ã—Ç—å –∫—É—Ä—Å—ã';
                }
            });
        });
    };
    
    /**
     * Full refresh of the entire UI.
     */
    const renderAll = () => {
        if (Object.keys(state.rates).length > 0) {
            app.loadingMessage.classList.add('hidden');
            app.accountsSection.classList.remove('hidden');
            app.logSection.classList.remove('hidden');
            renderDashboard();
            renderAccounts();
            renderLogs();
        }
    };
    
    // --- DATA MANAGEMENT (localStorage) ---
    const loadData = () => {
        const savedAccounts = localStorage.getItem('financeTrackerAccounts');
        state.accounts = savedAccounts ? JSON.parse(savedAccounts) : initialAccounts;
        
        const savedLogs = localStorage.getItem('financeTrackerLogs');
        state.logs = savedLogs ? JSON.parse(savedLogs) : [];
        state.logs.sort((a, b) => b.timestamp - a.timestamp); // Ensure sorted by timestamp
    };
    
    const saveAccounts = () => localStorage.setItem('financeTrackerAccounts', JSON.stringify(state.accounts));
    const saveLogs = () => localStorage.setItem('financeTrackerLogs', JSON.stringify(state.logs));

    /**
     * Exports all application data to a JSON file.
     */
    const exportData = () => {
        const dataToExport = {
            accounts: state.accounts,
            logs: state.logs
        };
        const filename = 'finance_tracker_data.json';
        const jsonStr = JSON.stringify(dataToExport, null, 2); // Pretty print JSON

        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url); // Clean up the object URL
    };

    /**
     * Imports data from a JSON file.
     * @param {Event} event The file input change event.
     */
    const importData = (event) => {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.accounts && importedData.logs) {
                    // Update state and localStorage
                    state.accounts = importedData.accounts;
                    state.logs = importedData.logs;
                    saveAccounts();
                    saveLogs();
                    renderAll();
                    console.log('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.');
                } else {
                    console.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç accounts –∏–ª–∏ logs.');
                    // You might want to show a user-friendly error message here
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —Ñ–∞–π–ª–∞ JSON:', error);
                // You might want to show a user-friendly error message here
            }
        };
        reader.readAsText(file);
    };

    /**
     * Fetches currency exchange rates.
     */
    const fetchRates = async () => {
        try {
            const response = await fetch('https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/rub.json');
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            const rubRates = data.rub;
            state.rates = Object.keys(rubRates).reduce((acc, currency) => {
                // Convert to RUB per unit of currency (e.g., how many RUB for 1 USD)
                acc[currency] = { value: 1 / rubRates[currency] };
                return acc;
            }, {});
        } catch (error) {
            console.error("Failed to fetch rates:", error);
            app.loadingMessage.innerHTML = `<p class="text-red-400 text-sm">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç.</p>`;
        } finally {
            renderAll();
        }
    };
    
    /**
     * Shows or hides a modal window.
     */
    const toggleModal = (show, modalEl) => {
        const contentEl = modalEl.querySelector('.modal-content');
        if (show) {
            modalEl.classList.remove('hidden');
            setTimeout(() => {
                modalEl.classList.remove('opacity-0');
                if (contentEl) contentEl.classList.remove('scale-95');
            }, 10);
        } else {
            modalEl.classList.add('opacity-0');
            if (contentEl) contentEl.classList.add('scale-95');
            setTimeout(() => modalEl.classList.add('hidden'), 300);
        }
    };
    
    /**
     * Handler for opening the account add/edit modal.
     */
    const handleOpenAccountModal = (accountId = null) => {
        app.modal.form.reset();
        app.modal.manualRateContainer.classList.add('hidden');
        if (accountId) {
            const account = state.accounts.find(acc => acc.id === accountId);
            app.modal.title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—á–µ—Ç';
            app.modal.id.value = account.id;
            app.modal.name.value = account.name;
            app.modal.amount.value = account.amount;
            app.modal.currency.value = account.currency;
            app.modal.type.value = account.type;
            if (account.manualRate) {
                app.modal.manualRateContainer.classList.remove('hidden');
                app.modal.manualRate.value = account.manualRate;
            }
        } else {
            app.modal.title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—á–µ—Ç';
            app.modal.id.value = '';
        }
        toggleModal(true, app.modal.el);
    };

    /**
     * Handler for form submission (add/edit account).
     */
    const handleFormSubmit = (e) => {
        e.preventDefault();
        const id = app.modal.id.value;
        const newAccountData = {
            name: app.modal.name.value.trim(),
            amount: parseFloat(app.modal.amount.value),
            currency: app.modal.currency.value.trim().toUpperCase(),
            type: app.modal.type.value,
        };
        
        if (app.modal.manualRate.value) {
            newAccountData.manualRate = parseFloat(app.modal.manualRate.value);
        } else {
            // Ensure manualRate is not saved if not provided or hidden
            delete newAccountData.manualRate;
        }

        if (id) {
            const index = state.accounts.findIndex(acc => acc.id === id);
            state.accounts[index] = { ...state.accounts[index], ...newAccountData };
        } else {
            newAccountData.id = Date.now().toString();
            state.accounts.push(newAccountData);
        }
        
        saveAccounts();
        renderAll();
        toggleModal(false, app.modal.el);
    };
    
    /**
     * Handler for deleting an account.
     */
    const handleDelete = () => {
        state.accounts = state.accounts.filter(acc => acc.id !== state.accountToDeleteId);
        state.accountToDeleteId = null;
        saveAccounts();
        renderAll();
        toggleModal(false, app.deleteModal.el);
    };
    
    /**
     * Handler for logging the current balance.
     */
    const handleLogBalance = () => {
        // Calculate all category totals
        let totals = { total: 0, rubles: 0, forex: 0, investments: 0, crypto: 0 };
        state.accounts.forEach(acc => {
            const rubValue = convertToRub(acc);
            totals.total += rubValue;
            if (acc.type === '–†—É–±–ª–∏') totals.rubles += rubValue;
            if (acc.type === '–í–∞–ª—é—Ç–∞') totals.forex += rubValue;
            if (acc.type === '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏') totals.investments += rubValue;
            if (acc.type === '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞') totals.crypto += rubValue;
        });

        // Determine relevant rates to store
        const relevantRates = {};
        const usedCurrencies = new Set();
        state.accounts.forEach(acc => {
            if (acc.currency.toUpperCase() !== 'RUB') {
                usedCurrencies.add(acc.currency.toLowerCase());
            }
        });

        // Add relevant fetched rates to relevantRates
        usedCurrencies.forEach(c => {
            if (state.rates[c]) {
                relevantRates[c] = state.rates[c];
            }
        });

        // If any account uses manualRate (which is always against USD in this setup), the USD rate is implicitly used
        if (state.accounts.some(acc => acc.manualRate) && state.rates.usd) {
            relevantRates.usd = state.rates.usd;
        }


        // Add the new log entry with breakdown and current rates snapshot
        state.logs.push({
            timestamp: Date.now(), // Use timestamp for unique entries
            total: totals.total,
            rubles: totals.rubles,
            forex: totals.forex,
            investments: totals.investments,
            crypto: totals.crypto,
            rates: relevantRates // Store only relevant rates
        });
        
        saveLogs();
        renderLogs();
    };

    // --- EVENT HANDLER SETUP ---
    
    app.addAccountBtn.addEventListener('click', () => handleOpenAccountModal());
    app.modal.cancelBtn.addEventListener('click', () => toggleModal(false, app.modal.el));
    app.modal.form.addEventListener('submit', handleFormSubmit);

    app.modal.currency.addEventListener('input', (e) => {
        const currency = e.target.value.toUpperCase();
        // Currencies that typically have auto-fetchable rates
        const autoCurrencies = ['RUB', 'USD', 'EUR', 'THB', 'GBP', 'JPY', 'CNY', 'CHF', 'CAD', 'AUD', 'NZD']; // Added more common currencies
        const shouldHideManualRate = autoCurrencies.includes(currency);
        app.modal.manualRateContainer.classList.toggle('hidden', shouldHideManualRate);
        if (shouldHideManualRate) {
            app.modal.manualRate.value = ''; // Clear manual rate if it's an auto-fetchable currency
        }
    });

    app.accountsList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-btn');
        if (editBtn) handleOpenAccountModal(editBtn.dataset.id);
        
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
            state.accountToDeleteId = deleteBtn.dataset.id;
            toggleModal(true, app.deleteModal.el);
        }
    });
    
    app.deleteModal.cancelBtn.addEventListener('click', () => toggleModal(false, app.deleteModal.el));
    app.deleteModal.confirmBtn.addEventListener('click', handleDelete);
    
    app.logBalanceBtn.addEventListener('click', handleLogBalance);

    // Event listeners for data management
    app.exportDataBtn.addEventListener('click', exportData);
    app.importDataBtn.addEventListener('click', () => app.importFileInput.click());
    app.importFileInput.addEventListener('change', importData);

    // --- APPLICATION INITIALIZATION ---
    const init = () => {
        loadData();
        fetchRates();
    };

    init();
});
</script>

</body>
</html>